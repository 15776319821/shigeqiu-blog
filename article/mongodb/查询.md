# 查询

<!-- TOC -->

- [查询](#查询)
    - [查询运算符](#查询运算符)
        - [范围查询运算符](#范围查询运算符)
        - [集合操作符总结](#集合操作符总结)
        - [布尔运算符总结](#布尔运算符总结)
        - [数组操作符](#数组操作符)
    - [聚合管道操作符](#聚合管道操作符)
        - [group 函数](#group-函数)
    - [重塑文档](#重塑文档)
        - [字符串函数](#字符串函数)
        - [算数运算函数](#算数运算函数)

<!-- /TOC -->

## 查询运算符

**eq 等于**

例如查询库存 qty 等于 20 的文档
```
db.inventory.find( { qty: { $eq: 20 } } )
```
等价于
```
db.inventory.find( { qty: 20 } )
```

### 范围查询运算符

| 运算符  | 描述  |
|---|---|
| $lt  | 小于  |
| $gt  | 大于  |
| $lte  | 小于等于  |
| $gte  | 大于等于  |

``` js
db.users.find({'brith_year':{'$gte':1985},'birth_year':{'$lte':2015}})
```
上述查询只会使用最后一个条件。我们可以按下面的方式编写正确的查询：
``` js
db.users.find({'brith_year':{'$gte':1985,'$lte':2015}})
```


### 集合操作符总结

| 操作符  | 描述  |
|---|---|
| $in  | 如果任意参数在引用集合里，则匹配  |
| $all  | 如果所有参数在引用集合里且被使用在包含数组的文档中，则匹配  |
| $nin  | 如果没有参数在引用集合里，则匹配  |


> 注意这是**集合操作符**，不是仅仅针对于数组的。

> 由于 $ne 和 $nin 运算符不是选择的，因此，当使用使用集合操作符时，记住 $in 和 $all 可以利用索引，但 $nin 不能利用索引而要集合浏览。 

``` js
db.products.find({'detail.color':{'$nin':["black","blue"]}})
```

### 布尔运算符总结

| 操作符  | 描述  |
|---|---|
| $ne  |  不匹配参数条件 |
| $not  | 不匹配结果  |
| $or  | 有一个条件匹配就成立  |
| $nor  | 所有条件都不匹配  |
| $and  | 所有条件都匹配  |
| $exists  | 判断元素是否存在  |

### 数组操作符

| 操作符  | 描述  |
|---|---|
| $elemMatch  | 如果提供的所有词语在相同的子文档中，则匹配  |
| $size  | 如果文档数组大小与提供的文本值相同，则匹配  |


## 聚合管道操作符


| 操作符  | 说明  |
|---|---|
| $project  |  指定要处理的字段 |
| $group  | 根据指定的key进行分组  |
| $match  | 选择要处理的文档，与find(...)类似  |
| $limit  | 限制传递给下一步的文档数量  |
| $skip  | 不传递给下一步的文档数量  |
| $unwind  | 扩展数组，为每个数组元素生成一个输出文档  |
| $sort  | 对文档排序  |
| $geoNear  | 选择地理位置附近的文档  |
| $out  | 把管道的结果输入一个集合里(2.6版本新增)  |
| $redact  | 控制特定数据的访问(2.6版本新增)  |

### group 函数

| 操作符  | 说明  |
|---|---|
| $addToSet  | 为阻力唯一的值创建一个数组  |
| $first  | 组里的第一个值，只有前缀$sort才有意义  |
| $last  |  组里最后一个值，只有前缀$sort才有意义 |
| $max  | 组里某个字段的最大值  |
| $min  | 组里某个字段的最小值  |
| $avg  | 某个字段的平均值  |
| $push  | 返回组内所有值的数组，不去除重复值  |
| $sum  | 求组内所有值的和  |


## 重塑文档

### 字符串函数

| 操作符  | 说明  |
|---|---|
| $concat  | 连接2个或者更多字符串为一个字符串  |
| $strcasecmp  | 大小写敏感的比较，返回数字  |
| $substr  | 获取字符串的子串  |
| $toLower  | 转换为小写字符串  |
| $toUpper  | 转换为大写字符串  |

### 算数运算函数

| 操作符  | 算数运算  |
|---|---|
| $add  | 求和  |
| $divide  | 除法  |
| $mod  | 求余数  |
| $multiply  | 乘积  |
| $subtract  | 减法  |

